<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>顧客管理</title>

  <!-- 高可読フォント -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./manage.css" />
</head>
<body class="view-auto">
  <!-- ▼ ローディング -->
  <div id="loading" class="loading" aria-hidden="false" aria-live="polite" aria-busy="true">
    <div class="loading-card">
      <div class="spinner" role="img" aria-label="読み込み中"></div>
      <p class="loading-text">データを読み込んでいます…</p>
      <button class="retry" hidden>再読み込み</button>
    </div>
  </div>
  <!-- ▲ ローディング -->

  <header>
    <h1>顧客管理</h1>

    <div class="tools">
      <input id="q" type="search" placeholder="名前・メール・電話で検索" />
      <input id="from" type="date" />
      <span class="tilde">〜</span>
      <input id="to" type="date" />

      <select id="menuFilter"><option value="">メニュー：すべて</option></select>
      <input id="tagFilter" type="search" placeholder="タグで絞り込み（例：VIP）" />

      <select id="quickSeg">
        <option value="">クイック：すべて</option>
        <option value="new">新規（30日以内/回数=1）</option>
        <option value="loyal">常連（回数≥5 & 90日以内）</option>
        <option value="idle">休眠（最終来店90日以上）</option>
      </select>

      <label class="inline"><input id="followOnly" type="checkbox" /> 要フォローのみ</label>

      <select id="sort">
        <option value="lastReservation:desc">最終来店 新→旧</option>
        <option value="lastReservation:asc">最終来店 旧→新</option>
        <option value="totalReservations:desc">来店回数 多→少</option>
        <option value="name:asc">名前 A→Z</option>
      </select>

      <button id="reload">再読込</button>
      <button id="exportCsv">CSV</button>
    </div>

    <div class="tools row2">
      <div class="view-toggle" role="group" aria-label="表示切替">
        <label><input type="radio" name="view" value="auto" checked> 自動</label>
        <label><input type="radio" name="view" value="mobile"> モバイル</label>
        <label><input type="radio" name="view" value="desktop"> PC</label>
      </div>

      <div class="segmented">
        <input id="segmentName" type="text" placeholder="条件に名前を付けて保存" />
        <button id="saveSegment">保存</button>
        <select id="savedSegments"><option value="">保存済み条件…</option></select>
        <button id="applySegment">適用</button>
        <button id="deleteSegment">削除</button>
      </div>

      <button id="toggleDuplicates">重複候補</button>
    </div>
  </header>

  <main>
    <!-- PC向け：表 -->
    <section id="customersSection" class="table-wrap">
      <table id="customers">
        <thead>
          <tr>
            <th>お名前</th>
            <th>連絡先</th>
            <th>住所</th>
            <th>最終来店</th>
            <th>回数</th>
            <th>直近メニュー</th>
            <th>担当者</th>
            <th>タグ / セグメント</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="pager"></div>
    </section>

    <!-- モバイル向け：カード -->
    <section id="cardsSection" class="cards" aria-hidden="true"></section>

    <!-- 右ドロワー：顧客プロファイル + 来店履歴 -->
    <section id="drawer" aria-hidden="true">
      <div class="drawer-inner">
        <button class="close" aria-label="閉じる">×</button>
        <h2 id="drawerTitle">顧客プロファイル & 来店履歴</h2>

        <div class="quick-actions" id="quickActions"></div>

        <!-- 流入元カウント -->
        <h3>予約の流入元カウント</h3>
        <div id="sourceStats" class="srcstats" aria-live="polite"></div>

        <div class="note-editor">
          <div class="grid">
            <label>氏名</label>           <input id="editName" type="text" />
            <label>氏名（カナ）</label>   <input id="editKana" type="text" />
            <label>性別</label>
            <select id="editGender">
              <option value="">未選択</option>
              <option>男性</option><option>女性</option><option>その他</option><option>未回答</option>
            </select>
            <label>電話番号</label>       <input id="editPhone" type="tel" />
            <label>メールアドレス</label> <input id="editEmail" type="email" />
            <label>住所</label>           <input id="editAddress" type="text" />
            <label>生年月日</label>       <input id="editBirthdate" type="date" />
            <label>担当者</label>         <input id="editStaff" type="text" />

            <label>タグ</label>           <input id="editTags" type="text" placeholder="カンマ区切り（例：VIP, 常連）" />
            <label>メモ</label>           <textarea id="editMemo" rows="3" placeholder="任意メモ"></textarea>

            <label>注意事項</label>       <textarea id="editAttention" rows="2" placeholder="アレルギー等、配慮点"></textarea>
            <label>配信同意</label>
            <div class="checks">
              <label><input type="checkbox" id="editOptEmail" />メール</label>
              <label><input type="checkbox" id="editOptLine" />LINE</label>
            </div>
            <label>同意日</label>         <input id="editConsentDate" type="date" />

            <label>紹介者</label>         <input id="editReferredBy" type="text" placeholder="紹介者名/コード" />
            <label>紹介コード</label>     <input id="editReferralCode" type="text" />

            <label>回数券</label>         <input id="editTicketType" type="text" placeholder="例：10回券" />
            <label>残回数</label>         <input id="editTicketRemain" type="number" min="0" />
            <label>有効期限</label>       <input id="editTicketExpiry" type="date" />

            <label>初回予約日</label>     <input id="editFirst" type="text" readonly />
            <label>最終予約日</label>     <input id="editLast" type="text" readonly />
          </div>
          <div id="lastIndicator" class="last-indicator"></div>
          <div class="row actions">
            <button id="editToggle" type="button">編集</button>
            <button id="saveNote" type="button" hidden>保存</button>
            <button id="cancelEdit" type="button" hidden>キャンセル</button>
            <span id="saveStatus" class="save-status" aria-live="polite"></span>
          </div>
        </div>

        <h3>来店履歴</h3>
        <table id="history">
          <thead>
            <tr>
              <th>日時</th>
              <th>メニュー</th>
              <th>項目</th>
              <th>流入元</th>
              <th>メモ</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- 重複候補パネル -->
    <section id="dupesPanel" class="dupes" aria-hidden="true">
      <div class="dupes-inner">
        <div class="head">
          <h2>重複候補</h2>
          <button class="close" aria-label="閉じる">×</button>
        </div>
        <div class="body">
          <table>
            <thead><tr><th>顧客A</th><th>顧客B</th><th>一致理由</th></tr></thead>
            <tbody id="dupesTbody"></tbody>
          </table>
          <p class="help">※いまは閲覧のみ（マージは後日）。</p>
        </div>
      </div>
    </section>

    <!-- 予約メールの token 表示（任意） -->
    <section id="tokenView" style="display:none;">
      <h2>予約リンクからの表示</h2>
      <pre id="tokenResult"></pre>
    </section>
  </main>

  <script src="./manage.js"></script>
</body>
</html>
