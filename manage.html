<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>顧客管理</title>

  <!-- 高可読フォント -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./manage.css" />
</head>
<body class="view-auto">
  <!-- ▼ ローディング -->
  <div id="loading" class="loading" aria-hidden="false" aria-live="polite" aria-busy="true">
    <div class="loading-card">
      <div class="spinner" role="img" aria-label="読み込み中"></div>
      <p class="loading-text">データを読み込んでいます…</p>
      <button class="retry" hidden>再読み込み</button>
    </div>
  </div>
  <!-- ▲ ローディング -->

  <header>
    <h1>顧客管理</h1>

    <!-- 行1：フィルター群（各項目にタイトル付き） -->
    <div class="tools">
      <label class="field field-q">
        <span class="title">検索キーワード</span>
        <input id="q" type="search" placeholder="名前・メール・電話で検索" />
      </label>

      <label class="field field-from">
        <span class="title">期間（開始）</span>
        <input id="from" type="date" />
      </label>

      <div class="field field-tilde">
        <span class="title">&nbsp;</span>
        <span class="tilde">〜</span>
      </div>

      <label class="field field-to">
        <span class="title">期間（終了）</span>
        <input id="to" type="date" />
      </label>

      <label class="field field-menu">
        <span class="title">メニュー</span>
        <select id="menuFilter"><option value="">すべて</option></select>
      </label>

      <label class="field field-tag">
        <span class="title">タグ</span>
        <input id="tagFilter" type="search" placeholder="例：VIP" />
      </label>

      <label class="field field-quick">
        <span class="title">クイック</span>
        <select id="quickSeg">
          <option value="">すべて</option>
          <option value="new">新規（30日以内/回数=1）</option>
          <option value="loyal">常連（回数≥5 & 90日以内）</option>
          <option value="idle">休眠（最終来店90日以上）</option>
        </select>
      </label>

      <label class="field field-sort">
        <span class="title">並び替え</span>
        <select id="sort">
          <option value="lastReservation:desc">最終来店 新→旧</option>
          <option value="lastReservation:asc">最終来店 旧→新</option>
          <option value="totalReservations:desc">来店回数 多→少</option>
          <option value="name:asc">名前 A→Z</option>
        </select>
      </label>

      <div class="field field-reload">
        <span class="title">データ更新</span>
        <button id="reload">再読込</button>
      </div>

      <div class="field field-csv">
        <span class="title">エクスポート</span>
        <button id="exportCsv">CSV</button>
      </div>
    </div>

    <!-- 行2：表示切替のみ -->
    <div class="tools row2">
      <div class="view-toggle" role="group" aria-label="表示切替">
        <label><input type="radio" name="view" value="auto" checked> 自動</label>
        <label><input type="radio" name="view" value="mobile"> モバイル</label>
        <label><input type="radio" name="view" value="desktop"> PC</label>
      </div>
    </div>
  </header>

  <main>
    <!-- PC向け：表 -->
    <section id="customersSection" class="table-wrap">
      <h2 class="section-title">顧客一覧（PC表示）</h2>
      <table id="customers">
        <thead>
          <tr>
            <th>お名前</th>
            <th>連絡先</th>
            <th>住所</th>
            <th>最終来店</th>
            <th>回数</th>
            <th>直近メニュー</th>
            <th>担当者</th>
            <th>タグ / セグメント</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="pager"></div>
    </section>

    <!-- モバイル向け：カード -->
    <section id="cardsSection" class="cards" aria-hidden="true">
      <h2 class="section-title">顧客一覧（モバイル表示）</h2>
    </section>

    <!-- 右ドロワー -->
    <section id="drawer" aria-hidden="true">
      <div class="drawer-inner">
        <button class="close" aria-label="閉じる">×</button>
        <h2 id="drawerTitle">顧客プロファイル & 来店履歴</h2>

        <div class="drawer-grid">
          <!-- 左：プロファイル＆流入元 -->
          <div class="profile-col">
            <div class="quick-actions" id="quickActions"></div>

            <h3>予約の流入元カウント</h3>
            <div id="sourceStats" class="srcstats" aria-live="polite"></div>

            <div class="note-editor">
              <h3>プロフィール編集</h3>
              <div class="grid">
                <label>氏名</label>           <input id="editName" type="text" />
                <label>氏名（カナ）</label>   <input id="editKana" type="text" />
                <label>性別</label>
                <select id="editGender">
                  <option value="">未選択</option>
                  <option>男性</option><option>女性</option><option>その他</option><option>未回答</option>
                </select>
                <label>電話番号</label>       <input id="editPhone" type="tel" />
                <label>メールアドレス</label> <input id="editEmail" type="email" />
                <label>住所</label>           <input id="editAddress" type="text" />
                <label>生年月日</label>       <input id="editBirthdate" type="date" />
                <label>担当者</label>         <input id="editStaff" type="text" />

                <label>タグ</label>           <input id="editTags" type="text" placeholder="カンマ区切り（例：VIP, 常連）" />
                <label>メモ</label>           <textarea id="editMemo" rows="3" placeholder="任意メモ"></textarea>

                <label>注意事項</label>       <textarea id="editAttention" rows="2" placeholder="アレルギー等、配慮点"></textarea>
                <label>配信同意</label>
                <div class="checks">
                  <label><input type="checkbox" id="editOptEmail" />メール</label>
                  <label><input type="checkbox" id="editOptLine" />LINE</label>
                </div>
                <label>同意日</label>         <input id="editConsentDate" type="date" />

                <label>紹介者</label>         <input id="editReferredBy" type="text" placeholder="紹介者名/コード" />
                <label>紹介コード</label>     <input id="editReferralCode" type="text" />

                <label>回数券</label>         <input id="editTicketType" type="text" placeholder="例：10回券" />
                <label>残回数</label>         <input id="editTicketRemain" type="number" min="0" />
                <label>有効期限</label>       <input id="editTicketExpiry" type="date" />

                <label>初回予約日</label>     <input id="editFirst" type="text" readonly />
                <label>最終予約日</label>     <input id="editLast" type="text" readonly />
              </div>

              <div id="lastIndicator" class="last-indicator"></div>

              <div class="row actions">
                <button id="editToggle" type="button">編集</button>
                <button id="saveNote" type="button" hidden>保存</button>
                <button id="cancelEdit" type="button" hidden>キャンセル</button>
                <span id="saveStatus" class="save-status" aria-live="polite"></span>
              </div>
            </div>
          </div>

          <!-- 右：来店履歴（PC=表 / モバイル=カード をJSで生成） -->
          <div class="history-col">
            <h3>来店履歴</h3>
            <div id="historyMount" aria-live="polite"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- 任意：予約メール token 表示 -->
    <section id="tokenView" style="display:none;">
      <h2>予約リンクからの表示</h2>
      <pre id="tokenResult"></pre>
    </section>
  </main>

  <script src="./manage.js"></script>
</body>
</html>
